<div [appSpinner]="commentsLoading.active || commentUpdating.active" spinnerSize="lg">
    <!-- Toolbar -->
    <div class="mb-3">
        <!-- Filter form -->
        <form [formGroup]="filterForm" class="row g-2 flex-grow-1">
            <!-- Placeholder to push other items to the right -->
            <div class="col"></div>

            <!-- Sort -->
            <div class="col-auto">
                <app-sort-selector [sort]="sort">
                    <app-sort-property by="score"   label="Score"   i18n-label></app-sort-property>
                    <app-sort-property by="created" label="Created" i18n-label></app-sort-property>
                </app-sort-selector>
            </div>

            <!-- Filter buttons -->
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <!-- Show approved -->
                    <input formControlName="approved" type="checkbox" class="btn-check" id="filterShowApproved" autocomplete="off">
                    <label for="filterShowApproved" class="btn btn-outline-secondary" title="Show approved" i18n-title>
                        <fa-icon [icon]="faCheck"></fa-icon>
                    </label>
                    <!-- Show pending -->
                    <input formControlName="pending" type="checkbox" class="btn-check" id="filterShowPending" autocomplete="off">
                    <label for="filterShowPending" class="btn btn-outline-secondary" title="Show pending" i18n-title>
                        <fa-icon [icon]="faQuestion"></fa-icon>
                    </label>
                    <!-- Show rejected -->
                    <input formControlName="rejected" type="checkbox" class="btn-check" id="filterShowRejected" autocomplete="off">
                    <label for="filterShowRejected" class="btn btn-outline-secondary" title="Show rejected" i18n-title>
                        <fa-icon [icon]="faXmark"></fa-icon>
                    </label>
                    <!-- Show others' comments (only if no user is explicitly provided) -->
                    <ng-container *ngIf="!userId">
                        <input formControlName="others" type="checkbox" class="btn-check" id="filterShowOthers" autocomplete="off">
                        <label for="filterShowOthers" class="btn btn-outline-secondary" title="Show others' comments" i18n-title>
                            <fa-icon [icon]="faUsersRays"></fa-icon>
                        </label>
                    </ng-container>
                </div>
            </div>

            <!-- Substring filter -->
            <div class="col-12 col-sm-auto">
                <input formControlName="filter" id="filterString" class="form-control" type="search"
                       placeholder="Filter" aria-label="Filter" i18n-placeholder i18n-aria-label>
            </div>
        </form>
    </div>

    <ng-container *ngIf="comments?.length">
        <!-- Comment list -->
        <div class="list-group">
            <div *ngFor="let c of comments"
                 [class.list-group-item-pending]="c.isPending"
                 [class.list-group-item-rejected]="!c.isPending && !c.isApproved" class="list-group-item clearfix">
                <!-- Comment metadata -->
                <div class="list-group-item-header row align-items-center">
                    <!-- User created -->
                    <div *ngIf="commenters.get(c.userCreated!) as cr" class="col">
                        <fa-icon [icon]="faUser" class="me-2"></fa-icon>
                        <ng-container>{{ cr.name }}</ng-container>
                        <!-- Pending badge -->
                        <span *ngIf="c.isPending" class="badge bg-warning ms-2" i18n>Pending</span>
                        <!-- Rejected badge -->
                        <span *ngIf="!c.isPending && !c.isApproved" class="badge bg-danger ms-2" i18n>Rejected</span>
                    </div>
                    <!-- Comment score -->
                    <div [class.text-danger]="c.score! < 0" [class.text-success]="c.score! > 0" title="Score"
                         class="col-auto fw-bold" i18n-title>{{ c.score }}</div>
                    <!-- Comment creation time and permalink -->
                    <div class="col-auto small text-muted">
                        <a [href]="c.url" title="Permalink" target="_blank" rel="noopener noreferrer" i18n-title>
                            <ng-container>{{ c.createdTime | datetime }}</ng-container>
                            <fa-icon [icon]="faUpRightFromSquare" class="ms-1"></fa-icon>
                        </a>
                    </div>
                </div>
                <div class="row align-items-start my-3">
                    <!-- Comment text -->
                    <div [innerHTML]="c.html" class="col"></div>
                    <!-- Action buttons -->
                    <div *ngIf="isModerator || c.userCreated === principal?.id" class="col-12 col-sm-auto btn-group btn-group-sm" role="group">
                        <!-- Approve -->
                        <button *ngIf="isModerator && !c.isDeleted" [class.active]="!c.isPending && c.isApproved"
                                (click)="moderateComment(c, true)"
                                class="btn btn-light text-success flex-grow-0" type="button" title="Approve" i18n-title>
                            <fa-icon [icon]="faCheck"></fa-icon>
                        </button>
                        <!-- Reject -->
                        <button *ngIf="isModerator && !c.isDeleted" [class.active]="!c.isPending && !c.isApproved"
                                (click)="moderateComment(c, false)"
                                class="btn btn-light text-warning flex-grow-0" type="button" title="Reject" i18n-title>
                            <fa-icon [icon]="faXmark"></fa-icon>
                        </button>
                        <!-- Delete -->
                        <button appConfirm="Are you sure you want to delete this comment?" (confirmed)="deleteComment(c)"
                                [class.active]="c.isDeleted" [disabled]="c.isDeleted"
                                class="btn btn-light text-danger flex-grow-0" type="button"
                                title="Delete" i18n-appConfirm i18n-title>
                            <fa-icon [icon]="faTrashAlt"></fa-icon>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item count -->
        <div class="py-2 text-center small text-muted">
            <ng-container *ngIf="!canLoadMore" i18n>All</ng-container>&ngsp;<ng-container>{{ comments!.length }}</ng-container>&nbsp;<ng-container i18n>items displayed</ng-container>
        </div>

        <!-- Load more items button -->
        <div *ngIf="canLoadMore" class="py-2 text-center">
            <button type="button" (click)="load.next(false)" class="btn btn-outline-secondary">
                <ng-container i18n>Load more</ng-container>
            </button>
        </div>
    </ng-container>

    <!-- Nothing found placeholder -->
    <div *ngIf="!commentsLoading.active && !comments?.length" class="py-4 text-center text-muted" i18n>Nothing found.</div>
</div>
